package main

import (
	"Vulnerability-Scanning-Tool/config"
	"Vulnerability-Scanning-Tool/scanner"
	"fmt"
	"os"
	"time"
)

type ScanResult struct {
	Target          string
	Vulnerabilities []scanner.VulnerabilityDetails // Use scanner.VulnerabilityDetails
}

func main() {
	// Load configuration from config.json
	config, err := config.LoadConfig("config.json")
	if err != nil {
		fmt.Println("Error loading config:", err)
		return
	}

	// All scanners used
	scanners := []scanner.VulnerabilityScanner{
		scanner.SQLInjectionScanner{},
		scanner.XSSScanner{},
		scanner.CSRFScanner{},
		// Add more scanners here
	}

	var scanResults []ScanResult

	// Loop through each target and check for vulnerabilities
	for _, target := range config.Targets {
		fmt.Println("Scanning target:", target)
		vulnerabilities := []scanner.VulnerabilityDetails{}

		for _, s := range scanners {
			// Capture start time
			vulnDetails, found := s.Scan(target, config.Headers)
			if found {
				// Add vulnerability details to the list
				vulnerabilities = append(vulnerabilities, vulnDetails)

				// Print vulnerability details to terminal
				fmt.Printf("Vulnerability detected: %s at %s\n", vulnDetails.Type, target)
				fmt.Printf("  Detected at: %s\n", vulnDetails.DetectedAt.Format(time.RFC3339))
				fmt.Printf("  Endpoint: %s\n", vulnDetails.Endpoint)
				fmt.Printf("  Payload: %s\n", vulnDetails.Payload)
				fmt.Printf("  Suggestion: %s\n", vulnDetails.Suggestion)
			}
		}

		// Store the result for this target
		if len(vulnerabilities) > 0 {
			result := ScanResult{Target: target, Vulnerabilities: vulnerabilities}
			scanResults = append(scanResults, result)
		} else {
			fmt.Println("No vulnerabilities found at:", target)
		}
	}

	// Generate the report
	fmt.Println("Scan completed. Generating report in Format:", config.ReportFormat)
	generateReport(scanResults)
}

// Function to generate the report in txt format
func generateReport(results []ScanResult) {
	file, err := os.Create("scan_report.txt")
	if err != nil {
		fmt.Println("Error creating report file:", err)
		return
	}
	defer file.Close()

	for _, result := range results {
		file.WriteString(fmt.Sprintf("Target: %s\n", result.Target))
		file.WriteString("Vulnerabilities Found:\n")
		for _, vuln := range result.Vulnerabilities {
			file.WriteString(fmt.Sprintf("- Type: %s\n", vuln.Type))
			file.WriteString(fmt.Sprintf("  Detected at: %s\n", vuln.DetectedAt.Format(time.RFC3339)))
			file.WriteString(fmt.Sprintf("  Endpoint: %s\n", vuln.Endpoint))
			file.WriteString(fmt.Sprintf("  Payload: %s\n", vuln.Payload))
			file.WriteString(fmt.Sprintf("  Suggestion: %s\n", vuln.Suggestion))
			file.WriteString("\n")
		}
		file.WriteString("\n")
	}

	fmt.Println("Report generated: scan_report.txt")
}
